name: Cr√©er l‚Äôutilisateur (idempotent)
        
          SUPABASE_URL: https://fwvrqngbafqdaekbdfnm.supabase.co
          # üëâ on injecte le secret directement ici (√©vite les soucis d'env vide)
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEW_USER_EMAIL: ${{ env.NEW_USER_EMAIL }}
          NEW_USER_PASSWORD: ${{ env.NEW_USER_PASSWORD }}
          EMAIL_CONFIRMED: ${{ env.EMAIL_CONFIRMED }}
        shell: bash
        run: |
          set -euo pipefail

          # Garde-fous
          if [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ]; then
            echo "‚ùå Secret SUPABASE_SERVICE_ROLE_KEY manquant (vide √† l'ex√©cution). V√©rifie le repository secret."
            exit 1
          fi
          if [ -z "${NEW_USER_EMAIL:-}" ]; then
            echo "‚ùå NEW_USER_EMAIL manquant."
            exit 1
          fi
          if [ -z "${NEW_USER_PASSWORD:-}" ]; then
            echo "‚ùå Aucun mot de passe d√©fini (champ password vide et secret NEW_USER_PASSWORD absent)."
            exit 1
          fi

          # bool√©en JSON propre
          EC="${EMAIL_CONFIRMED,,}"; if [ "$EC" = "true" ]; then EC=true; else EC=false; fi

          echo "‚û°Ô∏è Endpoint: $SUPABASE_URL/auth/v1/admin/users"
          echo "‚û°Ô∏è Email cible: $NEW_USER_EMAIL"

          # 1) GET: existe d√©j√† ?
          get_resp=$(curl -s -w "\n%{http_code}" -G "$SUPABASE_URL/auth/v1/admin/users" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            --data-urlencode "email=$NEW_USER_EMAIL")
          get_status=$(echo "$get_resp" | tail -n1)
          get_body=$(echo "$get_resp" | sed '$d')
          echo "GET /users?email=‚Ä¶ ‚Üí HTTP $get_status"

          if [ "$get_status" = "200" ] && echo "$get_body" | grep -q '"email"'; then
            echo "‚úÖ L'utilisateur existe d√©j√†, on ne recr√©e pas."
            exit 0
          fi

          # 2) POST: cr√©er
          payload=$(printf '{"email":"%s","password":"%s","email_confirm":%s}' \
            "$NEW_USER_EMAIL" "$NEW_USER_PASSWORD" "$EC")

          echo "Cr√©ation de l'utilisateur‚Ä¶"
          resp=$(curl -s -w "\n%{http_code}" -X POST "$SUPABASE_URL/auth/v1/admin/users" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            --data-raw "$payload")
          status=$(echo "$resp" | tail -n1)
          body=$(echo "$resp" | sed '$d')

          echo "POST /users ‚Üí HTTP $status"
          echo "$body"

          if [ "$status" -ge 400 ]; then
            echo "‚ùå √âchec de la cr√©ation."
            exit 1
          fi

          echo "‚úÖ Utilisateur cr√©√© avec succ√®s."
