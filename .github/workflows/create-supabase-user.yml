name: Create Supabase User

on:
  workflow_dispatch:
    inputs:
      email:
        description: "Email du nouvel utilisateur"
        required: true
        default: "maigre48@gmail.com"
      password:
        description: "Mot de passe (laisser vide pour utiliser le secret NEW_USER_PASSWORD)"
        required: false
      email_confirmed:
        description: "Marquer l'email comme confirmé ?"
        required: false
        default: "true"

jobs:
  create_user:
    runs-on: ubuntu-latest
    steps:
      - name: Préparer les variables
        run: |
          echo "SUPABASE_URL=https://fwvrqngbafqdaekbdfnm.supabase.co" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
          if [ -n "${{ github.event.inputs.password }}" ]; then
            echo "NEW_USER_PASSWORD=${{ github.event.inputs.password }}" >> $GITHUB_ENV
          else
            echo "NEW_USER_PASSWORD=${{ secrets.NEW_USER_PASSWORD }}" >> $GITHUB_ENV
          fi
          echo "NEW_USER_EMAIL=${{ github.event.inputs.email }}" >> $GITHUB_ENV
          echo "EMAIL_CONFIRMED=${{ github.event.inputs.email_confirmed }}" >> $GITHUB_ENV

      - name: Créer l’utilisateur dans Supabase
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          NEW_USER_EMAIL: ${{ env.NEW_USER_EMAIL }}
          NEW_USER_PASSWORD: ${{ env.NEW_USER_PASSWORD }}
          EMAIL_CONFIRMED: ${{ env.EMAIL_CONFIRMED }}
        run: |
          if [ -z "$NEW_USER_PASSWORD" ]; then
            echo "Erreur: Aucun mot de passe défini."
            exit 1
          fi

          JSON_BODY=$(cat <<EOF
          {
            "email": "$NEW_USER_EMAIL",
            "password": "$NEW_USER_PASSWORD",
            "email_confirm": $EMAIL_CONFIRMED
          }
          EOF
          )

          echo "Création de l'utilisateur $NEW_USER_EMAIL ..."
          resp=$(curl -s -w "\n%{http_code}" -X POST "$SUPABASE_URL/auth/v1/admin/users" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_BODY")

          status=$(echo "$resp" | tail
