      - name: Créer l’utilisateur dans Supabase
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          NEW_USER_EMAIL: ${{ env.NEW_USER_EMAIL }}
          NEW_USER_PASSWORD: ${{ env.NEW_USER_PASSWORD }}
          EMAIL_CONFIRMED: ${{ env.EMAIL_CONFIRMED }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${NEW_USER_PASSWORD:-}" ]; then
            echo "Erreur: Aucun mot de passe défini."
            exit 1
          fi

          # Normaliser email_confirmed en booléen JSON (true/false)
          EC="${EMAIL_CONFIRMED,,}"    # to lowercase
          if [ "$EC" = "true" ]; then
            EC=true
          else
            EC=false
          fi

          # Construire le payload JSON sans heredoc
          PAYLOAD=$(printf '{"email":"%s","password":"%s","email_confirm":%s}' \
            "$NEW_USER_EMAIL" "$NEW_USER_PASSWORD" "$EC")

          echo "Création de l'utilisateur $NEW_USER_EMAIL ..."
          resp=$(curl -s -w "\n%{http_code}" -X POST "$SUPABASE_URL/auth/v1/admin/users" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            --data-raw "$PAYLOAD")

          status=$(echo "$resp" | tail -n1)
          body=$(echo "$resp" | sed '$d')

          echo "HTTP $status"
          echo "$body"

          if [ "$status" -ge 400 ]; then
            echo "❌ Échec de la création."
            exit 1
          fi

          echo "✅ Utilisateur créé avec succès sur Supabase."
