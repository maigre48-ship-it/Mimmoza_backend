<!-- test rebuild -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mimmoza Auth Bridge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        max-width: 560px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .muted { color: #666; }
      button, input {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
      }
      .row { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
      pre {
        white-space: pre-wrap;
        word-break: break-all;
        background: #fafafa;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <h1>Mimmoza ‚Üí Base44 Auth Bridge</h1>
    <p class="muted">Connecte-toi √† Supabase puis envoie le JWT √† ton app Base44 via <code>postMessage</code>.</p>

    <div id="status" class="muted">Chargement‚Ä¶</div>

    <div id="login" style="display:none">
      <div class="row">
        <input id="email" type="email" placeholder="email@exemple.com" />
        <button id="magic">Lien magique</button>
      </div>
      <div class="row">
        <button id="google">Connexion Google</button>
        <button id="github">Connexion GitHub</button>
      </div>
    </div>

    <div id="session" style="display:none">
      <div class="row">
        <button id="send">Envoyer le JWT √† Base44</button>
        <button id="logout">Se d√©connecter</button>
      </div>
      <h3>JWT (debug temporaire)</h3>
      <pre id="jwtBox">(sera affich√© apr√®s connexion)</pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // --- CONFIG ---
  const SUPABASE_URL  = "https://fwvrqngbafqdaekbdfnm.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dnJxbmdiYWZxZGFla2JkZm5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2Njg1NzgsImV4cCI6MjA3ODI0NDU3OH0.cpgjWVBnXXjD5uL4yOT1xxdf1W8bQrGA04TlggHvS9o";
  const PARENT_ORIGIN = "https://mimmoza.base44.app";

  // --- DEBUG GLOBAL ---
  window.addEventListener("error", (e) => console.error("window.onerror:", e.message));
  window.addEventListener("unhandledrejection", (e) => console.error("unhandledrejection:", e.reason));

  console.log("[bridge] boot");

  const { createClient } = supabase;
  const client = createClient(SUPABASE_URL, SUPABASE_ANON);

  const el = (id) => document.getElementById(id);
  const $status = el("status"), $login = el("login"), $session = el("session"), $jwtBox = el("jwtBox");

  async function refresh() {
    try {
      console.log("[bridge] refresh() start");
      const { data: { session }, error } = await client.auth.getSession();
      if (error) console.error("[bridge] getSession error:", error);

      if (!session) {
        console.log("[bridge] no session -> show login");
        $status.textContent = "Non connect√©";
        $login.style.display = "";
        $session.style.display = "none";
        return;
      }
      console.log("[bridge] session present for:", session.user?.email);
      $status.textContent = `Connect√© : ${session.user.email}`;
      $login.style.display = "none";
      $session.style.display = "";
      $jwtBox.textContent = session.access_token;
    } catch (err) {
      console.error("[bridge] refresh() failed:", err);
      // Fallback UI pour √©viter le blocage "Chargement‚Ä¶"
      $status.textContent = "Non connect√© (mode secours)";
      $login.style.display = "";
      $session.style.display = "none";
    }
  }

  // --- Actions ---
  el("magic").onclick = async () => {
    const email = el("email").value.trim();
    if (!email) return alert("Saisis un email.");
    const { error } = await client.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: location.href }
    });
    if (error) alert(error.message);
    else $status.textContent = "Lien magique envoy√© üëå V√©rifie ta bo√Æte mail.";
  };

  el("google").onclick = async () => {
    await client.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: location.href }});
  };
  el("github").onclick = async () => {
    await client.auth.signInWithOAuth({ provider: 'github', options: { redirectTo: location.href }});
  };

  el("logout").onclick = async () => {
    await client.auth.signOut();
    $jwtBox.textContent = "";
    refresh();
  };

  el("send").onclick = async () => {
    const { data: { session } } = await client.auth.getSession();
    if (!session) return alert("Pas de session active.");
    window.parent.postMessage({ type: "SUPABASE_JWT", jwt: session.access_token }, PARENT_ORIGIN);
    $status.textContent = "‚úÖ JWT envoy√© √† Base44 (" + PARENT_ORIGIN + ")";
  };

  // Relance l‚ÄôUI si jamais le premier refresh plante
  client.auth.onAuthStateChange((_event, _session) => {
    console.log("[bridge] onAuthStateChange -> refresh");
    refresh();
  });

  // Fallback anti-cache : si rien n‚Äôa chang√© en 2s, on force l‚ÄôUI "Non connect√©"
  setTimeout(() => {
    if ($status.textContent.includes("Chargement")) {
      console.warn("[bridge] fallback timeout -> force login UI");
      $status.textContent = "Non connect√© (mode secours)";
      $login.style.display = "";
      $session.style.display = "none";
    }
  }, 2000);

  // GO
  refresh();
</script>
